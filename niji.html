<!DOCTYPE html>
<html lang="en">
	<head>
		<title>niji keyboard</title>
		<meta property="og:site_name" content="orbit-loona.github.io" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Niji keyboard" />
		<meta property="og:url" content="https://orbit-loona.github.io/niji.html" />
		<meta property="og:description" content="Type Niji online" />
		<meta property="og:locale" content="en_US" />
		<meta property="og:image" content="https://orbit-loona.github.io/bin/niji.png" />
		<meta property="og:image:width" content="222" />
		<meta property="og:image:height" content="53" />
		<meta property="og:image:alt" content="image" />
		<meta name="twitter:image:src" content="https://orbit-loona.github.io/bin/niji.png" />
		<meta name="twitter:title" content="niji keyboard" />
		<meta name="twitter:description" content="Type Niji online" />
		<link rel="stylesheet" href="main.css"/>
		<meta name="SKYPE_TOOLBAR" content="SKYPE_TOOLBAR_PARSER_COMPATIBLE">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="author" content="An Orbit">
		<meta charset="UTF-8">
		<style>
			@font-face {
				font-family: "Monnaka Plain";
				src: url("neededDueToCorsBullsh1t/MonnakaPlain.ttf");
			}
			
			body, #mainText, #buttons button {
				font-family: 'Gamja Flower', 'Comic Mono', 'Monnaka Plain', 'Arial', sans-serif;
			}
			
			#mainText {
				line-height: 125%;
			}
			
			#buttons, #buttons tr, #buttons td, #buttons th {
				border: 1px solid white;
				max-height: 33px;
			}
			
			#buttons td, padding: 2px {
				padding: 2px;
			}

			#buttons {
				border-collapse: collapse;
			}
			
			#buttons button, #buttons th div, div.spacer {
				width: 30px;
				height: 30px;
				max-width: 30px;
				max-height: 30px;
				text-align: center;
				overflow: hidden;
			}
			
			#buttons th div {
				display: table-cell;
				vertical-align: middle;
				font-size: 90%;
			}

			#buttons th, #buttons td {
				display: table-cell;
				vertical-align: middle;
				font-size: 90%;
			}

			#buttons tr td:has(div.spacer) {
				border-right: unset;
			}

			#buttons button, div.spacer {
				font-size: 110%;
			}
			
			#mainText {
				width: 550px;
				height: 350px;
			}

			a.footnote, a.footnote:visited {
				text-decoration: underline;
				color: #0ff;
			}

			:target {
				background-color: #ffff002f;
				border: 1px solid yellow;
				padding: 8px;
			}
			
			.tiny {
				font-size: 5%
			}
			
			div#footnotes {
				font-size: 85%
			}
		</style>
		<script>
			//https://stackoverflow.com/a/16427747
			function isLocalStorageAvailable() {
				var test = 'test';
				try {
					localStorage.setItem(test, test);
					localStorage.removeItem(test);
					return true;
				} catch(e) {
					return false;
				}
			};
			
			var localStorageIsAvailable = isLocalStorageAvailable();
			if(!isLocalStorageAvailable) {
				alert("Local storage is not available. Text will not be saved when you refresh.")
			};

			function saveText() {
				if(!isLocalStorageAvailable) {
					return false
				};
				var _textbox = document.getElementById("mainText");
				if(_textbox) {
					var text = _textbox.value;
					localStorage.setItem("text",text);
					return text.length
				} else {
					return false
				}
			};

			function loadText() {
				if(!isLocalStorageAvailable) {
					return false
				};
				var _textbox = document.getElementById("mainText");
				if(_textbox) {
					var text = localStorage.getItem("text");
					_textbox.value = text
					return text.length
				} else {
					return false
				}
			}
		</script>
	</head>
	<body>
		<h1>Niji keyboard</h1>
		<div id="description">
			<p>This is a quick-and-dirty keyboard for the <a href="https://norbertlindenberg.com/2018/03/niji-script/index.html">Norbert Lindenberg's <em>Niji</em> script</a>. Norbert's font (<em>Monnaka Plain</em>) does all of the rendering work (which is impressive). This tool just lets you type in the script.</p><br/>
			
			<p>This script is encoded in the <a href="https://en.wikipedia.org/wiki/Private_Use_Areas">Unicode <em>Private Use Area</em></a> and will not render properly on most pages<sup><small class="tiny"> </small><a href="#footnote-1" class="footnote">1</a></sup> unless you <a href="https://norbertlindenberg.com/shared/MonnakaPlain.ttf">install the font</a><sup><small class="tiny"> </small><a href="#footnote-2" class="footnote">2</a></sup></p>

			<div id="bottom">
				<div id="footnotes">
					<ol>
						<li id="footnote-1">The exceptions where it will render even without installing the font are pages that embed the special font as a <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Styling_text/Web_fonts">web font</a>; of those, I only know about this page and N. Lindenberg's website.</li>
						<li id="footnote-2">This may be complicated or impossible on certain systems, which <em>is not Lindenberg's fault</em>.</li>
					</ol>
				</div>
				<br/>
			</div>
		</div>
		<textarea id="mainText"></textarea>
		<table id="buttons">
			<tbody>
				<tr id="labelrow0">
					<td><div class="spacer">&nbsp;</div></td>
				</tr>
				<tr id="buttonrow0">
					<td><button title="(No consonant)" labeloverride="∅"></button></td>
					<td><button title="K"></button></td>
					<td><button title="S"></button></td>
					<td><button title="Sh"></button></td>
					<td><button title="T"></button></td>
					<td><button title="Ch"></button></td>
					<td><button title="Ts"></button></td>
					<td><button title="N"></button></td>
					<td><button title="H"></button></td>
					<td><button title="F"></button></td>
					<td><button title="M"></button></td>
					<td><button title="Y"></button></td>
					<td><button title="R"></button></td>
					<td><button title="W"></button></td>
					<td><button title="G"></button></td>
					<td><button title="Z"></button></td>
					<td><button title="J"></button></td>
					<td><button title="D"></button></td>
					<td><button title="B"></button></td>
					<td><button title="P"></button></td>
					<td><button title="V"></button></td>
				</tr>
				<tr id="labelrow1">
					<td><div class="spacer">&nbsp;</div></td>
				</tr>
				<tr id="buttonrow1">
					<td><button title="A"></button></td>
					<td><button title="I"></button></td>
					<td><button title="U"></button></td>
					<td><button title="E"></button></td>
					<td><button title="O"></button></td>
					<td><button title="Length mark" labeloverride="ー"></button></td>
					<td><button title="(Space)" labeloverride="⌴" textoverride=" ">&nbsp;</button></td>
					<td><button title="(New line)" labeloverride="⏎" textoverride="&#10;">&nbsp;</button></td>
					<td><button title="(Backspace)" labeloverride="⌫" textoverride="&#8;" style="font-size: 80%">␈</button></td>
				</tr>
			</tbody>
		</table><br/><br/>
		<script>
			var everyFifthInputCounter = 0;
			function everyFifthInputSaveHandler() {
				if(everyFifthInputCounter < 0) { everyFifthInputCounter = 0 };
				everyFifthInputCounter++;
				if(everyFifthInputCounter >= 5) {
					saveText();
					everyFifthInputCounter %= 5
				}
			};
		
			nijiConversionKey = {
				[null]: "",
				"": "",
				a: "",
				i: "",
				u: "",
				e: "",
				o: "",
				k: "",
				s: "",
				sh: "",
				"h": "",
				t: "",
				ch: "",
				ts: "",
				"s": "",
				n: "",
				h: "",
				f: "",
				m: "",
				y: "",
				r: "",
				w: "",
				g: "",
				z: "",
				j: "",
				d: "",
				b: "",
				p: "",
				v: ""
			};
			
			var englishVowels = "aiueo".split("");
			
			var nijiConsonants = Object.entries(nijiConversionKey).filter(pair => !(englishVowels.includes(pair[0]))).map(x => x[1]);

			var nijiConsonantsWithoutY = structuredClone(nijiConsonants);
			nijiConsonantsWithoutY.splice(nijiConsonantsWithoutY.indexOf(""));

			var nijiConsonantsWithoutN = structuredClone(nijiConsonants);
			nijiConsonantsWithoutN.splice(nijiConsonantsWithoutN.indexOf(""));

			var nijiVowels = Object.values(nijiConversionKey).filter(letter => !(nijiConsonants.includes(letter)));
			
			var lastVowelTypedBeforeLengthMark = null;
			
			var ZWNJ = "‌";
			
			var _newCursorSelectionStart = 0;
			var _newCursorSelectionEnd = 0;
			
			var textbox = document.getElementById("mainText");
			
			function logEdges() {
				console.log(_newCursorSelectionStart,_newCursorSelectionEnd)
			};
			
			//make clicks update the stored cursor position
			textbox.addEventListener("click",function(e) {
				_newCursorSelectionStart = e.target.selectionStart;
				_newCursorSelectionEnd = e.target.selectionEnd;
				//logEdges()
			});

			//make arrow presses update the stored cursor position
			textbox.addEventListener("keyup",function(e) {
				if(e.keyCode >= 37 && e.keyCode <= 40) {
					_newCursorSelectionStart = e.target.selectionStart;
					_newCursorSelectionEnd = e.target.selectionEnd
				};
				//logEdges()
			});

			textbox.addEventListener("focusout",saveText);

			//main roman-to-niji typing code (dirty hacks)
			textbox.addEventListener("input",function(e) {
				_newCursorSelectionStart = e.target.selectionStart;
				_newCursorSelectionEnd = e.target.selectionEnd
				var text = this.value;
				
				var resultingStringBeforeCursor = text.slice(0,_newCursorSelectionStart);
				var resultingStringAfterCursor = text.slice(_newCursorSelectionEnd);
				var last3 = resultingStringBeforeCursor.slice(-3).toLowerCase();
				var last2 = resultingStringBeforeCursor.slice(-2).toLowerCase();
				var last1 = resultingStringBeforeCursor.slice(-1).toLowerCase();
				switch(last2) {
					case "gg": //manual override because for some reason auto-tsuing doesn't work with G specifically
					case "g":
						resultingStringBeforeCursor = resultingStringBeforeCursor.replace(/[g]$/,"");
						this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
						_newCursorSelectionStart++;
						_newCursorSelectionEnd++;
					case "sh":
					case "h":
					case "ch":
						if(last3[0] == "c") {
							resultingStringBeforeCursor = resultingStringBeforeCursor.replace(/cch$/i,"");
						};
					case "ts":
					case "s":
						resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last2 + "$","i"),nijiConversionKey[last2]);
						this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
						_newCursorSelectionStart--;
						_newCursorSelectionEnd--;
						break;
					default:
						if((nijiConsonantsWithoutN.includes(last2[0])) && last2[0] == nijiConversionKey[last1]) {
							var regex = RegExp(`${last2[0]}(${last1})$`,"i");
							//console.log(regex,resultingStringBeforeCursor.match(regex));
							resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(`${last2[0]}(${last1})$`,"i"),"$1");
							this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
						};
						switch(last1) {
							case "y":
								if(!(nijiConsonantsWithoutY.includes(last2[0]))) {
									resultingStringBeforeCursor = resultingStringBeforeCursor.slice(0,-1) + "" + resultingStringBeforeCursor.slice(-1);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
									_newCursorSelectionStart++;
									_newCursorSelectionEnd++;
								};
							case "k":
							case "s":
							case "t":
							case "n":
							case "h":
							case "f":
							case "m":
							case "r":
							case "w":
							case "g":
							case "z":
							case "d":
							case "j":
							case "b":
							case "p":
							case "v":
								resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),nijiConversionKey[last1]);
								this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
								break;
							/*case "'":
								if(last2[0] == "") {
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),ZWNJ);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
									textbox.selectionStart = _newCursorPosition + 1;
									textbox.selectionEnd = _newCursorPosition + 1;
									break
								};
							*/
							case "a":
							case "i":
							case "u":
							case "e":
							case "o":
								if(nijiConsonants.includes(last2[0])) {
									lastVowelTypedBeforeLengthMark = last1;
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),nijiConversionKey[last1]);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
								} else if(((nijiVowels.includes(last2[0])) || (last2[0] == "")) && (lastVowelTypedBeforeLengthMark === last1)) {
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),"");
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
								} else {
									lastVowelTypedBeforeLengthMark = last1;
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),"" + nijiConversionKey[last1]);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
									_newCursorSelectionStart++;
									_newCursorSelectionEnd++;
								};
								break;
						}
				};
				textbox.selectionStart = _newCursorSelectionStart;
				textbox.selectionEnd = _newCursorSelectionEnd;
				if(localStorageIsAvailable) { everyFifthInputSaveHandler() }
			});
			
			var keyboard = document.getElementById("buttons");
			if(keyboard) {
				var rows = keyboard.querySelectorAll('tr[id^="buttonrow"]') ?? [];
				var rowIndices = Array.from(rows).map(n => n.getAttribute("id").match(/\d+$/)?.[0]).filter(s => !!s).map(x => parseInt(x));
				if(rowIndices.length > 0) {
					var highestIndex = Math.max(...rowIndices);
					var lowestIndex = Math.min(...rowIndices);
					for(var i = lowestIndex; i <= highestIndex; i++) {
						//get button and label rows
						var buttonRow = document.getElementById(`buttonrow${i.toString()}`);
						var labelRow = document.getElementById(`labelrow${i.toString()}`);
						
						//create missing label rows
						if(!labelRow) {
							labelRow = document.createElement("tr");
							labelRow.setAttribute("id",`labelrow${i.toString()}`);
							buttonRow.before(labelRow)
						};
						
						//clear label row
						var lrcn = labelRow.childNodes;
						for(var j = 0; j < lrcn.length; j++) {
							labelRow.removeChild(lrcn[j]);
							lrcn[j].outerHTML = "";
							lrcn[j] = null
						};
						
						//get buttons
						var buttons = buttonRow.querySelectorAll("button");
						
						//do buttON stuff
						for(var j = 0; j < buttons.length; j++) {
							var button = buttons[j];
							
							//create labels
							var labelText = ((button.getAttribute("labeloverride") ?? button.getAttribute("title")) ?? "").toLowerCase();
							var newLabel = document.createElement("th");
								var newDiv = document.createElement("div");
									newDiv.innerText = labelText;
								newLabel.appendChild(newDiv)
							labelRow.appendChild(newLabel)
							
							//make the buttons actually work
							button.addEventListener("click",function() {
								var text = textbox.value;
								
								var textToAdd = this.getAttribute("textoverride") ?? this.innerText;
								var isBackspace = (textToAdd == "\x08");

								if(isBackspace) {
									if(_newCursorSelectionEnd < _newCursorSelectionStart) { _newCursorSelectionEnd = _newCursorSelectionStart };
									if(_newCursorSelectionEnd == 0) { return };
									resultingStringBeforeCursor = text.slice(0,_newCursorSelectionStart - (_newCursorSelectionStart == _newCursorSelectionEnd));
									resultingStringAfterCursor = text.slice(_newCursorSelectionEnd);
									_newCursorSelectionStart -= (_newCursorSelectionStart == _newCursorSelectionEnd);
								} else {
									resultingStringBeforeCursor = text.slice(0,_newCursorSelectionStart) + textToAdd;
									resultingStringAfterCursor = text.slice(_newCursorSelectionEnd);
									_newCursorSelectionStart += textToAdd.length;
								};
								textbox.value = resultingStringBeforeCursor+resultingStringAfterCursor;
								_newCursorSelectionEnd = _newCursorSelectionStart
								textbox.selectionStart = _newCursorSelectionStart;
								textbox.selectionEnd = _newCursorSelectionEnd;
								if(localStorageIsAvailable) { everyFifthInputSaveHandler() }
							})
						}
					}
				}
			};

			if(isLocalStorageAvailable) {
				if(localStorage.getItem("text") === null) {
					localStorage.setItem("text","")
				} else {
					loadText()
				}
			}
		</script>
		
		<br/><br/><a href="index.html"><small>go to main page</small></a>

	</body>
</html>
